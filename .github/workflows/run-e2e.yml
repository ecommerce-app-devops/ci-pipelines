name: Run E2E and Performance Tests

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Namespace to test (dev, stage, prod)'
        required: false
        default: 'dev'
  workflow_call:
    inputs:
      namespace:
        required: false
        default: 'dev'
        type: string
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_CLIENT_SECRET:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      RESOURCE_GROUP:
        required: true

jobs:
  e2e-and-performance-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Set Azure credentials
        uses: azure/login@v1
        with:
          creds: >-
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            }

      - name: Clear Azure CLI MSAL cache
        run: rm -f ~/.azure/msal_http_cache.bin

      - name: Upgrade Azure CLI to latest
        run: |
          az upgrade --yes
          az version

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Get AKS credentials
        run: |
          which az
          az version
          az aks get-credentials \
            --resource-group "${{ secrets.RESOURCE_GROUP }}" \
            --name microservices-cluster-prod \
            --overwrite-existing

      - name: Get API Gateway IP
        id: get_ip
        run: |
          NAMESPACE="${{ inputs.namespace }}"
          
          # Wait for IP to be assigned
          for i in {1..30}; do
            IP=$(kubectl get svc api-gateway -n "$NAMESPACE" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [[ -n "$IP" && "$IP" != "null" ]]; then
              echo "API_GATEWAY_IP=$IP" >> $GITHUB_OUTPUT
              echo "API_GATEWAY_URL=http://$IP" >> $GITHUB_OUTPUT
              echo "Got API Gateway IP: $IP for namespace $NAMESPACE"
              exit 0
            fi
            echo "⏳ Waiting for IP... (attempt $i/30)"
            sleep 5
          done
          
          echo "Failed to get API Gateway IP"
          exit 1

      - name: Verify Services in Eureka
        run: |
          NAMESPACE="${{ inputs.namespace }}"
          
          echo "Verifying all services are registered in Eureka..."
          
          # Port-forward Eureka temporarily
          kubectl port-forward -n "$NAMESPACE" svc/service-discovery 8761:8761 > /dev/null 2>&1 &
          EUREKA_PF_PID=$!
          sleep 5
          
          # Expected services
          EXPECTED_SERVICES=("API-GATEWAY" "USER-SERVICE" "PRODUCT-SERVICE" "PAYMENT-SERVICE" "ORDER-SERVICE" "SHIPPING-SERVICE" "FAVOURITE-SERVICE" "PROXY-CLIENT")
          
          for i in {1..30}; do
            REGISTERED=$(curl -s http://localhost:8761/eureka/apps | grep -o '<name>[^<]*</name>' | grep -v 'MyOwn' || echo "")
            
            ALL_REGISTERED=true
            MISSING=()
            
            for svc in "${EXPECTED_SERVICES[@]}"; do
              if echo "$REGISTERED" | grep -q "$svc"; then
                echo "  ✓ $svc"
              else
                echo "  ✗ $svc - missing"
                MISSING+=("$svc")
                ALL_REGISTERED=false
              fi
            done
            
            if [ "$ALL_REGISTERED" = true ]; then
              echo "✓ All services registered in Eureka"
              kill $EUREKA_PF_PID 2>/dev/null
              exit 0
            fi
            
            echo "⏳ Waiting for services... (attempt $i/30)"
            sleep 5
          done
          
          echo "✗ Failed to register all services in Eureka"
          echo "   Missing: ${MISSING[@]}"
          kill $EUREKA_PF_PID 2>/dev/null
          exit 1

      - name: Run E2E Tests
        run: |
          API_URL="${{ steps.get_ip.outputs.API_GATEWAY_URL }}"
          echo "Running E2E tests against: $API_URL"
          
          # Set API Gateway URL as environment variable for tests
          export API_GATEWAY_URL="$API_URL"
          
          # Run E2E tests with Maven
          # Note: Tests may need to be configured to use API_GATEWAY_URL environment variable
          mvn test -Dtest=*E2ETest \
            -Dspring.profiles.active=test \
            -Dapi.gateway.url="$API_URL" \
            -Dmaven.test.failure.ignore=true
        env:
          API_GATEWAY_URL: ${{ steps.get_ip.outputs.API_GATEWAY_URL }}
        continue-on-error: true

      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-results
          path: |
            **/target/surefire-reports/*.xml
            **/target/surefire-reports/*.txt
          if-no-files-found: ignore

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Locust dependencies
        run: |
          cd ci-pipelines/performance-tests
          pip install -r requirements.txt

      - name: Run Locust Performance Tests
        run: |
          API_URL="${{ steps.get_ip.outputs.API_GATEWAY_URL }}"
          cd ci-pipelines/performance-tests
          
          echo "Running Locust performance tests against: $API_URL"
          echo "Test configuration: 100 users, 10 spawn rate, 2 minutes duration"
          
          locust -f locustfile.py \
            --host="$API_URL" \
            --headless \
            -u 100 \
            -r 10 \
            -t 2m \
            --html locust-report.html \
            --csv locust-results \
            --loglevel INFO
        continue-on-error: true

      - name: Upload Locust Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: locust-results
          path: |
            ci-pipelines/performance-tests/locust-report.html
            ci-pipelines/performance-tests/locust-results*.csv

